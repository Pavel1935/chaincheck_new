name: Smoke tests

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "0 5 * * *"
    - cron: "0 6 */14 * *"

jobs:
  smoke:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/python:v1.55.0-jammy
      options: --ipc=host --shm-size=1g

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install "pytest<8.3.0" "allure-pytest>=2.13.2"

      - name: Install Allure CLI
        run: |
          apt-get update
          apt-get install -y default-jre wget unzip
          ALLURE_VERSION=2.29.0
          wget -q https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.zip -O /tmp/allure.zip
          unzip -q /tmp/allure.zip -d /opt/
          ln -sf /opt/allure-${ALLURE_VERSION}/bin/allure /usr/bin/allure
          allure --version

      - name: Prepare allure-results
        run: rm -rf allure-results && mkdir -p allure-results

      - name: Add Allure metadata
        run: |
          mkdir -p allure-results
          cat > allure-results/executor.json <<'EOF'
          {
            "name": "GitHub Actions",
            "type": "github",
            "reportName": "Smoke tests",
            "buildName": "${{ github.workflow }} #${{ github.run_number }}",
            "buildUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "environment": "${{ github.ref_name }}"
          }
          EOF
          echo "branch=${{ github.ref_name }}" >> allure-results/environment.properties
          echo "runner=ubuntu-latest" >> allure-results/environment.properties

      - name: Run API smoke tests
        run: |
          pytest -m "smoke and api" -vv -ra \
                 --alluredir=allure-results \
                 --clean-alluredir

      - name: Wait before UI tests
        run: sleep 180

      - name: Run UI smoke tests
        run: |
          pytest -m "smoke and ui" -vv -ra \
                 --alluredir=allure-results

      - name: Check allure-results content
        if: always()
        run: |
          echo "Checking allure-results folder:"
          ls -la allure-results || echo "‚ùå No allure-results directory found"

      - name: Upload Allure results (raw)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
          if-no-files-found: warn

      - name: Generate Allure HTML report
        if: always()
        run: |
          export ALLURE_BASE_URL="/${GITHUB_REPOSITORY#*/}/"
          allure generate allure-results -o allure-report --clean
          ls -la allure-report | head -n 30

      - name: Deploy Allure Report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
          force_orphan: true

      - name: Comment report URL
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: smoke-report
          message: "‚úÖ Allure report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"


  bot_test:
    if: github.event_name == 'schedule' || github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: smoke

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install telethon pytest allure-pytest

      # üîê Restore Telegram session (B64 secret -> file)
      - name: Restore Telegram session
        run: |
          printf '%s' "${{ secrets.TG_SESSION_B64 }}" | base64 -d > chainscheck_qa_bot.session
          ls -la chainscheck_qa_bot.session
          wc -c chainscheck_qa_bot.session

      # ‚úÖ –®–ê–ì 1: –î–ï–ë–ê–ì –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ù–ï –ø–µ—á–∞—Ç–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç—ã)
      - name: Debug Telegram authorization
        run: |
          python3 - <<'PY'
          from pathlib import Path
          from telethon.sync import TelegramClient
          from Constants import Constants
          
          SESSION_FILE = "chainscheck_qa_bot.session"
          p = Path(SESSION_FILE)
          print("session_exists:", p.exists())
          print("session_size:", p.stat().st_size if p.exists() else None)
          
          client = TelegramClient("chainscheck_qa_bot", Constants.API_ID, Constants.API_HASH)
          client.connect()
          print("authorized:", client.is_user_authorized())
          if client.is_user_authorized():
              me = client.get_me()
              print("me:", me.id, me.username)
          client.disconnect()
          PY

      - name: Prepare allure-results
        run: rm -rf allure-results && mkdir -p allure-results

      - name: Run bot tests
        run: |
          pytest -m "smoke and bot" -vv -ra \
                 --alluredir=allure-results

      - name: Upload Bot Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-bot
          path: allure-results
          if-no-files-found: warn

      - name: Generate Bot HTML Report
        if: always()
        run: |
          npm install -g allure-commandline
          allure generate allure-results -o bot-report --clean

      - name: Deploy Bot Report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: bot-report
          publish_branch: gh-pages
          destination_dir: bot
          force_orphan: false

      - name: Comment bot report URL
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: bot-report
          message: |
            ü§ñ **Telegram Bot Tests report**
            üëâ https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/bot/
